{% extends "auctions/layout.html" %}

{% block body %}
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <h2>{{ listing.title }}</h2>
    <h4>({{listing.category}})</h4>

    {% if listing.image %}
        <img src="{{ listing.image }}" alt="{{ listing.title }}" style="max-height: 400px; max-width: 600px;">
    {% endif %}

    <p>{{ listing.description }}</p>

    <h4>Current Bid: ${{ current_bid }}</h4>

    {% if user.is_authenticated and listing.is_active %}
        {% if user in listing.watchers.all %}
            <a href="{% url 'watchlist_toggle' listing.id %}" class="btn btn-danger">Remove from Watchlist</a>
        {% else %}
            <a href="{% url 'watchlist_toggle' listing.id %}" class="btn btn-primary">Add to Watchlist</a>
        {% endif %}

        <p></p>

        <form action="{% url 'listing_page' listing.id %}" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <input type.html"number" name="bid_amount" min="{{ current_bid }}" step="0.01" class="form-control" placeholder="Your Bid">
                <input type="submit" value="Place Bid" class="btn btn-success mt-2">
            </div>
        </form>

        {% if user.is_authenticated and user == listing.creator %}
            <h4>Admin: Close this Auction</h4>
            <p>Warning: This action cannot be undone.</p>

            <form action="{% url 'close_auction' listing.id %}" method="POST">
                {% csrf_token %}
                <input type="submit" value="Close Auction" class="btn btn-danger">
            </form>
        {% endif %}
        
        {% if user.is_authenticated %}
            <h4>Add a Comment here</h4>
            <form action="{% url 'listing_page' listing.id %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="comment_text" class="form-control" rows="3" placeholder="Write your comment..."></textarea>
                </div>
        
                <input type="submit" name="submit_comment" value="Post Comment" class="btn btn-primary mt-2">
            </form>
        {% endif %}

        <hr> 
        <h3>Comments</h3>
        <div class="comment-section">
            {% for comment in comments %}
                <div class="comment" style="border: 1px solid #eee; padding: 10px; margin-bottom: 10px;">
                    <strong>{{ comment.author.username }}</strong>
                    <small>on {{ comment.timestamp|date:"F j, Y, g:i a" }}</small>
                    <p>{{ comment.content }}</p>
                </div>
            {% empty %}
                <p>No Comments yet.</p>
            {% endfor %}
        </div>

    {% endif %}

    <hr>

{% endblock %}